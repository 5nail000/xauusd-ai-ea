# План создания Transformer модели для торговли золотом

## Цель проекта

Создать Transformer-нейросеть для торговли золотом (XAUUSD) на минутном таймфрейме с тиковым анализом:
- Классификация сигналов: **пробой**, **отскок**, **неопределенность**
- Тейк-профит: 50-130 пунктов
- Стоп-лосс: 100 пунктов с трейлингом

## Этап 1: Подготовка данных для золота (XAUUSD) ✅ ГОТОВО

### Задачи:
1. ✅ Загрузка данных по XAUUSD из MT5 (опционально: от 1 месяца до года, по умолчанию 6 месяцев)
2. ✅ Загрузка тиковых данных (последняя 1 минута перед каждой свечой)
3. ✅ Генерация всех фичей (включая тиковые)
4. ✅ Создание целевых переменных для классификации:
   - **Пробой**: будущая доходность > 50 пунктов в одном направлении без разворота
   - **Отскок**: разворот после движения (доходность меняет знак, движение > 30 пунктов в обратную сторону)
   - **Неопределенность**: движение < 50 пунктов или отсутствие четкого направления
5. ✅ Разделение на train/validation/test (70/15/15)

### Модули: ✅ СОЗДАНЫ
- `data/target_generator.py` - генерация целевых переменных
- `data/gold_data_prep.py` - подготовка данных по золоту
- `data/data_splitter.py` - разделение данных на train/val/test
- `prepare_gold_data.py` - скрипт для подготовки данных

## Этап 2: Архитектура Transformer модели ✅ ГОТОВО

### Реализованы две архитектуры:

1. **Encoder-Only Transformer** (простая и быстрая)
   - Быстрое обучение
   - ~2-4M параметров
   - Хорошо для прототипирования

2. **Time Series Transformer** (продвинутая)
   - Временное кодирование
   - Multi-scale attention
   - ~3-6M параметров
   - Максимальная точность

### Кастомная архитектура для временных рядов:
- Encoder блоки с multi-head attention
- Positional encoding для временных последовательностей
- Feed-forward сети
- Dropout и normalization слои
- Выходной слой для классификации (3 класса)

### Параметры модели:
- Длина последовательности: 60 минут (1 час истории)
- Размерность эмбеддингов: 128-256
- Количество encoder блоков: 4-6
- Количество attention heads: 8
- Dropout: 0.1-0.2

### Модули: ✅ СОЗДАНЫ
- `models/base_transformer.py` - базовый класс Transformer
- `models/transformer_encoder.py` - Encoder-Only модель
- `models/transformer_timeseries.py` - Time Series модель
- `models/model_factory.py` - фабрика для создания моделей
- `config/model_config.py` - конфигурация модели

## Этап 3: Обучение модели ✅ ГОТОВО

### Процесс обучения:
- ✅ Оптимизатор: AdamW с learning rate 1e-4
- ✅ Learning rate scheduling (cosine annealing)
- ✅ Early stopping на основе validation accuracy
- ✅ Сохранение лучших весов
- ✅ Мониторинг метрик: accuracy, precision, recall, F1 для каждого класса

### Модули: ✅ СОЗДАНЫ
- `models/trainer.py` - обучение модели
- `models/callbacks.py` - callbacks для обучения (EarlyStopping, ModelCheckpoint, LearningRateScheduler)
- `models/data_loader.py` - DataLoader для последовательностей
- `train_model.py` - скрипт для обучения

## Этап 4: Валидация и тестирование ✅ ГОТОВО

### Метрики:
- ✅ Accuracy, Precision, Recall, F1 для каждого класса
- ✅ Confusion matrix с визуализацией
- ✅ Classification report
- ✅ Распределение классов

### Модули: ✅ СОЗДАНЫ
- `models/evaluator.py` - оценка модели

## Этап 5: Бэктестинг торговой стратегии ✅ ГОТОВО

### Правила торговли:
- ✅ **Вход**: сигнал от модели (пробой или отскок)
- ✅ **Тейк-профит**: 50-130 пунктов (динамический на основе уверенности)
- ✅ **Стоп-лосс**: 100 пунктов
- ✅ **Трейлинг стоп**: активация после достижения 30 пунктов прибыли, шаг 20 пунктов
- ✅ **Размер позиции**: базовый лот 0.1, множитель для надежных сигналов
- ✅ **Частичное закрытие**: 50% позиции при достижении 60 пунктов прибыли
- ✅ **Мониторинг аномалий**: отслеживание входных значений, выходящих за 3σ от обучающей выборки

### Метрики бэктестинга:
- ✅ Общая доходность
- ✅ Win rate
- ✅ Profit factor
- ✅ Средняя прибыль/убыток
- ✅ Максимальная прибыль/убыток
- ✅ История equity

### Модули: ✅ СОЗДАНЫ
- `trading/backtester.py` - бэктестинг стратегии
- `trading/position_manager.py` - управление позициями (трейлинг стоп, частичное закрытие)
- `config/trading_config.py` - конфигурация торговых параметров
- `backtest_strategy.py` - скрипт бэктестинга

## Этап 6: Интеграция с MT5 для реальной торговли

### Expert Advisor (EA):
- Реал-тайм генерация фичей из последних 60 минут
- Использование обученной модели для прогнозирования
- Автоматическое открытие/закрытие позиций
- Управление рисками и позициями
- Логирование всех действий

### Модули:
- `trading/mt5_ea.py` - Expert Advisor для MT5
- `trading/position_manager.py` - управление позициями
- `trading/logger.py` - логирование

## Порядок выполнения

1. ✅ **Готово**: Генерация фичей (включая тиковые)
2. ✅ **Готово**: Создание целевых переменных (пробой/отскок/неопределенность)
3. ✅ **Готово**: Создание архитектуры Transformer (encoder и timeseries)
4. ✅ **Готово**: Подготовка данных по золоту (с кэшированием и аргументами командной строки)
5. ✅ **Готово**: Обучение модели (с мониторингом, визуализацией, анализом переобученности)
6. ✅ **Готово**: Валидация и тестирование
7. ✅ **Готово**: Бэктестинг стратегии (с логированием, детальной статистикой и мониторингом аномалий)
8. ✅ **Готово**: Синхронизация и валидация фичей между обучением и применением
9. ✅ **Готово**: Единый pipeline для полного цикла (`full_pipeline.py`)
10. ✅ **Готово**: Экспорт документации по фичам (автоматически после обучения)
11. ⏳ **Следующее**: Оптимизация параметров торговли
12. ⏳ Создание EA для MT5
13. ⏳ Тестирование на демо-счете

## Новые возможности

### Кэширование и сохранение прогресса ✅
- Автоматическое сохранение промежуточных результатов генерации фичей
- Кэширование тиковых данных
- Сохранение финального датасета
- Возобновление после прерывания

### Мониторинг обучения ✅
- История обучения в CSV и PNG
- Визуализация кривых обучения
- Анализ переобученности
- Автоматические рекомендации

### Улучшенные скрипты ✅
- `prepare_gold_data.py` - аргументы командной строки
- `train_all_models.py` - автоматическое обучение обеих моделей
- `full_pipeline.py` - единый скрипт для полного цикла
- Детальное логирование в бэктестере

### Синхронизация и валидация фичей ✅
- Автоматическое сохранение метаданных о фичах в scaler
- Валидация соответствия фичей при загрузке модели
- Утилиты для проверки и сравнения фичей
- Предотвращение ошибок при несоответствии фичей

### Экспорт документации по фичам ✅
- Автоматическое создание документации после обучения
- Два формата: JSON и Markdown
- Полная информация о каждом фиче (описание, формула, источник, статистика)
- Легкая передача модели другим пользователям

## Зависимости (дополнительные)

- `torch` или `tensorflow` - для нейросетей
- `transformers` (опционально) - для готовых компонентов Transformer
- `matplotlib`, `seaborn` - для визуализации
- `tqdm` - для прогресс-баров

