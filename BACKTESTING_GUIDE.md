# Руководство по бэктестингу

## Обзор

Модуль бэктестинга торговой стратегии на основе Transformer модели для классификации сигналов.

## Особенности

### Управление позициями

- **Базовый лот**: 0.1 (настраивается)
- **Множитель для надежных сигналов**: при уверенности > 0.8 лот умножается на 1.5
- **Частичное закрытие**: 50% позиции закрывается при достижении 60 пунктов прибыли
- **Трейлинг стоп**: активируется после 30 пунктов прибыли, шаг 20 пунктов

### Правила торговли

- **Тейк-профит**: 50-130 пунктов (динамический на основе уверенности модели)
- **Стоп-лосс**: 100 пунктов
- **Вход**: только при сигнале от модели (пробой или отскок)
- **Неопределенность**: пропуск торговли

## Использование

### Быстрый старт

```bash
python backtest_strategy.py
```

Скрипт автоматически:
1. Загрузит обученную модель
2. Загрузит тестовые данные
3. Запустит бэктестинг
4. Сохранит результаты

### Настройка параметров

В `backtest_strategy.py` можно изменить:

```python
trading_config = TradingConfig(
    base_lot_size=0.1,              # Базовый размер лота
    take_profit_min=50.0,           # Минимальный TP
    take_profit_max=130.0,          # Максимальный TP
    stop_loss=100.0,                # Стоп-лосс
    use_trailing_stop=True,         # Использовать трейлинг
    trailing_start=30.0,            # Активация трейлинга
    trailing_step=20.0,             # Шаг трейлинга
    use_partial_close=True,         # Частичное закрытие
    partial_close_at=60.0,          # Уровень частичного закрытия
    partial_close_ratio=0.5,        # Доля для закрытия
    use_signal_confidence=True,      # Использовать уверенность
    confidence_threshold=0.8,        # Порог уверенности
    confidence_multiplier=1.5,       # Множитель лота
    spread_pips=2.0                  # Спред
)
```

## Результаты бэктестинга

После запуска создаются файлы:

1. **`trading/backtest_results.csv`** - общая статистика
2. **`trading/equity_history.csv`** - история equity
3. **`trading/closed_positions.csv`** - все закрытые позиции

### Метрики

- **Total Trades**: общее количество сделок
- **Win Rate**: процент прибыльных сделок
- **Total Profit**: общая прибыль
- **Profit Factor**: отношение валовой прибыли к валовому убытку
- **Max Profit/Loss**: максимальная прибыль/убыток
- **Return %**: доходность в процентах

## Программное использование

```python
from trading.backtester import Backtester
from config.trading_config import TradingConfig
import pandas as pd

# Конфигурация
trading_config = TradingConfig(
    base_lot_size=0.1,
    take_profit_min=50.0,
    take_profit_max=130.0,
    stop_loss=100.0
)

# Создание бэктестера
backtester = Backtester(
    model_path='models/checkpoints/encoder_model.pth',
    scaler_path='models/feature_scaler.pkl',
    model_type='encoder',
    trading_config=trading_config
)

# Загрузка данных
test_df = pd.read_csv('data/gold_test.csv', index_col=0, parse_dates=True)

# Запуск бэктестинга
results = backtester.backtest(test_df, start_idx=60)

# Получение статистики
stats = backtester.position_manager.get_statistics()
print(f"Win Rate: {stats['win_rate']:.2f}%")
print(f"Total Profit: ${stats['total_profit']:.2f}")
```

## Логика торговли

### Определение направления

1. **Пробой (класс 1)**: вход по направлению тренда
   - Восходящий тренд → покупка
   - Нисходящий тренд → продажа

2. **Отскок (класс 2)**: вход против тренда
   - Восходящий тренд → продажа
   - Нисходящий тренд → покупка

3. **Неопределенность (класс 0)**: пропуск торговли

### Управление позицией

- **Трейлинг стоп**: автоматически обновляется при движении в прибыль
- **Частичное закрытие**: фиксирует часть прибыли
- **Динамический TP**: увеличивается для надежных сигналов

## Анализ результатов

### Equity Curve

История equity показывает:
- Динамику баланса
- Максимальную просадку
- Тренд доходности

### Закрытые позиции

Детальная информация о каждой сделке:
- Время входа/выхода
- Цены входа/выхода
- Прибыль/убыток
- Причина выхода (TP, SL, трейлинг)

## Оптимизация

Можно оптимизировать:
- Пороги TP/SL
- Параметры трейлинга
- Уровни частичного закрытия
- Пороги уверенности модели

## Следующие шаги

После бэктестинга:
1. Анализ результатов
2. Оптимизация параметров
3. Тестирование на других периодах
4. Подготовка к реальной торговле

