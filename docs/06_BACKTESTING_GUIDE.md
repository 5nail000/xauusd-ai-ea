# Руководство по бэктестингу

## Обзор

Модуль бэктестинга торговой стратегии на основе Transformer модели для классификации сигналов.

## Особенности

### Управление позициями

- **Базовый лот**: 0.1 (настраивается)
- **Множитель для надежных сигналов**: при уверенности > 0.8 лот умножается на 1.5
- **Частичное закрытие**: 50% позиции закрывается при достижении 60 пунктов прибыли
- **Трейлинг стоп**: активируется после 30 пунктов прибыли, шаг 20 пунктов

### Правила торговли

- **Тейк-профит**: 50-130 пунктов (динамический на основе уверенности модели)
- **Стоп-лосс**: 100 пунктов
- **Вход**: только при сигнале от модели (пробой или отскок)
- **Неопределенность**: пропуск торговли

## Использование

### Быстрый старт

```bash
python backtest_strategy.py
```

Скрипт автоматически:
1. Загрузит обученную модель
2. Загрузит scaler с автоматической валидацией фичей
3. Загрузит тестовые данные
4. Запустит бэктестинг с мониторингом аномалий
5. Сохранит результаты

### Настройка параметров

В `backtest_strategy.py` можно изменить:

```python
trading_config = TradingConfig(
    base_lot_size=0.1,              # Базовый размер лота
    take_profit_min=50.0,           # Минимальный TP
    take_profit_max=130.0,          # Максимальный TP
    stop_loss=100.0,                # Стоп-лосс
    use_trailing_stop=True,         # Использовать трейлинг
    trailing_start=30.0,            # Активация трейлинга
    trailing_step=20.0,             # Шаг трейлинга
    use_partial_close=True,         # Частичное закрытие
    partial_close_at=60.0,          # Уровень частичного закрытия
    partial_close_ratio=0.5,        # Доля для закрытия
    use_signal_confidence=True,      # Использовать уверенность
    confidence_threshold=0.8,        # Порог уверенности
    confidence_multiplier=1.5,       # Множитель лота
    spread_pips=2.0                  # Спред
)
```

## Результаты бэктестинга

### Вывод в терминал

Во время бэктестинга выводятся:
- **Открытие каждой позиции**: время, цена, лот, уверенность, TP/SL
- **Закрытие каждой позиции**: время, цена, прибыль, причина, длительность

В конце выводится детальная статистика:
- Общая статистика (всего сделок, прибыльных, убыточных, Win Rate)
- Финансовые результаты (общая прибыль, средняя, максимум, минимум)
- Анализ эффективности (Profit Factor, валовой доход/убыток)
- Баланс (начальный, финальный, доходность)
- Причины выхода из позиций (TP, SL, trailing stop, конец данных)

### Сохранение результатов

После запуска создаются файлы:

1. **`trading/backtest_results.csv`** - общая статистика (агрегированная)
2. **`trading/equity_history.csv`** - история equity (доступна в `results['equity_history']`)

**Примечание**: Детальные данные по сделкам доступны через `backtester.position_manager.closed_positions`

### Метрики

- **Total Trades**: общее количество сделок
- **Win Rate**: процент прибыльных сделок
- **Total Profit**: общая прибыль
- **Profit Factor**: отношение валовой прибыли к валовому убытку
- **Max Profit/Loss**: максимальная прибыль/убыток
- **Return %**: доходность в процентах

## Программное использование

```python
from trading.backtester import Backtester
from config.trading_config import TradingConfig
import pandas as pd

# Конфигурация
trading_config = TradingConfig(
    base_lot_size=0.1,
    take_profit_min=50.0,
    take_profit_max=130.0,
    stop_loss=100.0
)

# Создание бэктестера
backtester = Backtester(
    model_path='models/checkpoints/encoder_model.pth',
    scaler_path='models/feature_scaler.pkl',
    model_type='encoder',
    trading_config=trading_config
)

# Загрузка данных
test_df = pd.read_csv('data/gold_test.csv', index_col=0, parse_dates=True)

# Запуск бэктестинга
results = backtester.backtest(test_df, start_idx=60)

# Получение статистики
stats = backtester.position_manager.get_statistics()
print(f"Win Rate: {stats['win_rate']:.2f}%")
print(f"Total Profit: ${stats['total_profit']:.2f}")
```

## Логика торговли

### Определение направления

1. **Пробой (класс 1)**: вход по направлению тренда
   - Восходящий тренд → покупка
   - Нисходящий тренд → продажа

2. **Отскок (класс 2)**: вход против тренда
   - Восходящий тренд → продажа
   - Нисходящий тренд → покупка

3. **Неопределенность (класс 0)**: пропуск торговли

### Управление позицией

- **Трейлинг стоп**: автоматически обновляется при движении в прибыль
- **Частичное закрытие**: фиксирует часть прибыли
- **Динамический TP**: увеличивается для надежных сигналов

## Анализ результатов

### Equity Curve

История equity (`results['equity_history']`) показывает:
- Динамику баланса по времени
- Незакрытую прибыль открытых позиций
- Максимальную просадку (можно вычислить)
- Тренд доходности

```python
# Построение графика equity
import matplotlib.pyplot as plt

equity_df = results['equity_history']
plt.plot(equity_df['time'], equity_df['equity'])
plt.title('Equity Curve')
plt.xlabel('Time')
plt.ylabel('Equity ($)')
plt.show()
```

### Закрытые позиции

Детальная информация о каждой сделке доступна через:

```python
closed_positions = backtester.position_manager.closed_positions

# Каждая позиция содержит:
# - entry_time, exit_time
# - entry_price, exit_price
# - direction (1=BUY, -1=SELL)
# - lot_size
# - profit
# - exit_reason ('tp', 'sl', 'trailing', 'end_of_data')
# - signal_confidence

# Сохранение в CSV для анализа
import pandas as pd
df_positions = pd.DataFrame(closed_positions)
df_positions.to_csv('trading/closed_positions.csv', index=False)
```

### Метрики

Все метрики доступны через `results`:

```python
stats = results
print(f"Win Rate: {stats['win_rate']:.2f}%")
print(f"Total Profit: ${stats['total_profit']:.2f}")
print(f"Profit Factor: {stats['profit_factor']:.2f}")
print(f"Max Drawdown: ${stats['max_loss']:.2f}")
```

## Оптимизация

Можно оптимизировать:
- Пороги TP/SL
- Параметры трейлинга
- Уровни частичного закрытия
- Пороги уверенности модели

## Мониторинг аномалий

Система автоматически отслеживает аномалии во время бэктестинга:

- **Проверка значений**: для каждого сигнала проверяется, выходят ли значения за 3σ от обучающей выборки
- **Снижение уверенности**: при обнаружении аномалии уверенность модели снижается пропорционально
- **Пропуск сигналов**: если >50% фичей аномальны, сигнал пропускается

Статистика аномалий выводится после бэктестинга:

```
⚠️  Мониторинг аномалий:
  Всего проверок: 1000
  Обнаружено аномалий: 45 (4.5%)
  Сигналов пропущено: 12
  Уверенность снижена: 33 раз
```

Подробнее см. [11_FEATURE_OPTIMIZATION.md](11_FEATURE_OPTIMIZATION.md)

## Следующие шаги

После бэктестинга:
1. Анализ результатов
2. Проверка статистики аномалий
3. Оптимизация параметров
4. Тестирование на других периодах
5. Подготовка к реальной торговле

