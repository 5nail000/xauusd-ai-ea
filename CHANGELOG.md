# История изменений

Все значимые изменения в проекте документируются в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
и проект придерживается [Semantic Versioning](https://semver.org/lang/ru/).

## [Unreleased]

### Добавлено
- Реорганизация структуры проекта в `workspace/`
  - Централизованное хранение всех данных, моделей и результатов
  - Структура: `workspace/raw_data/`, `workspace/prepared/`, `workspace/models/`, `workspace/results/`
  - Упрощенная миграция данных между машинами (например, для обучения на Paperspace)
- Переход на 5 классов для классификации сигналов
  - 0 = Неопределенность
  - 1 = Пробой вверх (BUY)
  - 2 = Пробой вниз (SELL)
  - 3 = Отскок вверх (BUY после падения)
  - 4 = Отскок вниз (SELL после роста)
  - Увеличены пороги: `breakout_threshold=200.0`, `bounce_threshold=150.0`
  - Улучшена логика генерации таргетов (приоритет отскокам, проверка разворота до 70% периода)
- Отложенный вход для отскоков в бэктестере
  - Сигналы отскоков (классы 3, 4) сохраняются и ожидают подтверждения
  - Подтверждение по паттерну свечей (минимум/максимум за последние 3-5 свечей, затем разворот)
  - Настраиваемые параметры в `TradingConfig`: `bounce_confirmation_enabled`, `bounce_confirmation_periods`, `bounce_min_reversal_pips`
- Расширенный `paperspace_utils.py` (переименован из `upload_to_paperspace.py`)
  - Классы `PaperspaceUploader` и `PaperspaceDownloader`
  - Загрузка данных для обучения с опциональными тиками и кэшами
  - Скачивание результатов обучения (модели, метрики, scalers, логи)
  - CLI интерфейс с командами: `upload-training`, `download-results`, `create-training-archive`, `create-results-archive`, `list-remote-files`
- Интеграция интерактивных метрик обучения
  - TensorBoard: автоматическое логирование метрик по батчам и эпохам
  - Weights & Biases (W&B): опциональное облачное логирование с поддержкой сравнения экспериментов
  - Скрипт `utils/start_tensorboard.py` для автоматического запуска TensorBoard
  - Документация по метрикам: `docs/14_METRICS_GUIDE.md`
- Памятка о следующих шагах: `.cursor/plans/NEXT_STEPS.md`
  - Чеклист проверок перед финальным обучением
  - Рекомендации по настройке порогов и валидации данных
  - Команды для тестирования на малой выборке

### Изменено
- Улучшен скрипт анализа корреляции фичей (`analyze_feature_correlation.py`)
  - Исправлен DeprecationWarning при проверке типов данных (использование `pd.api.types.is_numeric_dtype()`)
  - Обновлены пути по умолчанию на новую структуру `workspace/`
  - Добавлено автоматическое сохранение результатов анализа в таблицы CSV:
    - Таблица высококоррелированных пар
    - Таблица фичей для удаления
    - Таблица статистики анализа
  - Добавлена защита базовых OHLC фичей (open, high, low, close) - они никогда не удаляются
  - Улучшена логика выбора фичей для удаления:
    - Приоритет отдается простым/коротким именам (sma_5 > close_rolling_mean_5)
    - Предпочтение стандартным названиям индикаторов (momentum > close_momentum_10)
    - Специальная обработка дубликатов с корреляцией = 1.0
    - Система приоритетов для разных типов фичей
- Система мониторинга производительности и защиты от деградации модели
  - PerformanceMonitor: отслеживание метрик (Win Rate, Profit Factor, просадка, серии убытков)
  - ModelDriftDetector: обнаружение дрифта модели (изменение распределения данных)
  - MonitoringVisualizer: визуализация метрик и дашборды
  - Автоматическое снижение размера позиций при предупреждениях
  - Автоматическая остановка торговли при критических ситуациях
  - Настраиваемые пороги для WARNING/CRITICAL/STOPPED протоколов
- Документация по мониторингу производительности (docs/12_PERFORMANCE_MONITORING.md)
- Прогресс-бар для обработки тиковых фичей с отображением процента выполнения, оценки оставшегося времени и скорости обработки
- Скрипт `upload_to_paperspace.py` для упаковки и отправки данных на Paperspace
- Файл `requirements_linux.txt` с зависимостями для Linux (без MetaTrader5)
- Документация по настройке обучения на Paperspace (docs/13_PAPERSPACE_SETUP.md)

### Изменено
- `data/tick_data_loader.py`: сохранение прогресса теперь ведётся чанками, чтобы чекпойнты занимали постоянное время даже на сотнях тысяч свечей
- При возобновлении загрузки прогресс собирается из отдельных чанков, а после успешного завершения промежуточные файлы автоматически очищаются

### Исправлено
- Устранены предупреждения `RuntimeWarning: invalid value encountered in divide` при вычислении корреляции и автокорреляции в статистических фичах
  - Добавлена проверка стандартного отклонения перед вычислением корреляции
  - Добавлено подавление предупреждений numpy при корректных вычислениях
  - Улучшена обработка фичей с нулевым стандартным отклонением в `_remove_correlated_features`
- Оптимизировано использование памяти при создании последовательностей для обучения
  - Изменен тип данных с `float64` на `float32` в `SequenceGenerator.create_sequences()`
  - Уменьшение использования памяти в 2 раза (с ~30 ГБ до ~15 ГБ для больших датасетов)
  - Позволяет обучать модели на машинах с 30+ ГБ RAM (например, Paperspace)

## [2025-11-25] - Исправления и оптимизации

### Исправлено
- Исправлена ошибка памяти при сохранении больших объемов тиков (50+ миллионов)
  - Убрано полное копирование DataFrame в tick_cache.py
  - Оптимизирован процесс сохранения: данные обрабатываются по частям
- Исправлено подключение к MT5
  - TickDataLoader теперь использует существующее подключение MT5
  - Предотвращены конфликты при преждевременном отключении

### Добавлено
- Автоматическое создание минутных свечей из тиков
  - Когда минутных данных недостаточно (брокер хранит только 3-6 месяцев)
  - Система автоматически дополняет недостающие периоды из тиков
- Улучшенная диагностика ошибок при загрузке данных
  - Детальные сообщения об ошибках
  - Автоматический поиск похожих символов

### Изменено
- Обновлена документация: README.md, docs/00_INDEX.md, docs/03_DATA_PREPARATION.md, docs/09_TICK_CACHE_GUIDE.md

## [2025-11-24] - Основные функции

### Добавлено
- Единый pipeline скрипт (`full_pipeline.py`)
  - Полный цикл: подготовка → обучение → бэктестинг одной командой
  - Умные проверки наличия данных/моделей
  - Гибкие параметры через командную строку
- Синхронизация фичей
  - Автоматическое сохранение метаданных о фичах в scaler
  - Валидация соответствия фичей при загрузке модели
  - Утилиты для проверки и сравнения фичей (`utils/feature_validator.py`, `validate_features.py`)
- Экспорт документации по фичам
  - Автоматическое создание документации после обучения
  - Два формата: JSON и Markdown
  - Полная информация о каждом фиче (описание, формула, источник, статистика)
  - Скрипты: `export_features_doc.py`, `utils/feature_documentation.py`
- Мониторинг аномалий
  - Отслеживание входных значений, выходящих за 3σ от обучающей выборки
  - Автоматическое снижение уверенности или пропуск сигналов при аномалиях
- Анализ корреляции фичей
  - Автоматическое удаление высококоррелированных фичей
  - Скрипт `analyze_feature_correlation.py`
  - Настраиваемый порог корреляции в `config/feature_config.py`

### Изменено
- `models/data_loader.py`: добавлено сохранение метаданных в scaler
- `trading/backtester.py`: добавлена валидация фичей и мониторинг аномалий
- `features/feature_engineering.py`: добавлено удаление коррелированных фичей
- `train_all_models.py` и `train_model.py`: автоматический экспорт документации

## [2025-11-23] - Базовые функции

### Добавлено
- Система подготовки данных
  - Загрузка данных из MT5 (минутные и тиковые)
  - Генерация фичей (технические индикаторы, тиковые фичи, временные фичи)
  - Кэширование тиковых данных
  - Создание целевых переменных (пробой, отскок, неопределенность)
- Модели Transformer
  - Encoder-Only Transformer
  - Time Series Transformer
  - Обучение с early stopping и callbacks
- Система бэктестинга
  - Управление позициями
  - Трейлинг стоп
  - Частичное закрытие
  - Расчет метрик производительности
- Документация
  - Полная документация в папке `docs/`
  - Руководства по установке, подготовке данных, обучению, бэктестингу

---

## Формат записей

- **Добавлено** - для новых функций
- **Изменено** - для изменений в существующей функциональности
- **Устарело** - для функций, которые скоро будут удалены
- **Удалено** - для удаленных функций
- **Исправлено** - для исправления ошибок
- **Безопасность** - для уязвимостей

