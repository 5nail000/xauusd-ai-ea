# Руководство по кэшированию тиков

## Обзор

Система автоматического кэширования тиковых данных для оптимизации загрузки и хранения.

## Особенности

- **Автоматическое кэширование**: тики сохраняются в `data/ticks/`
- **Автоматическая загрузка**: если кэша нет, загружаются последние 1.5 года
- **Догрузка**: автоматическая догрузка недостающих тиков
- **Хранение по дням**: каждый день хранится в отдельном файле
- **Метаданные**: отслеживание покрытия кэша

## Структура кэша

```
data/ticks/
├── tick_metadata.pkl          # Метаданные кэша
├── XAUUSD_20240101.pkl       # Тики за 1 января 2024
├── XAUUSD_20240102.pkl       # Тики за 2 января 2024
└── ...
```

## Использование

### Автоматическое (рекомендуется)

Кэширование включено по умолчанию:

```python
from data.tick_data_loader import TickDataLoader

loader = TickDataLoader(use_cache=True)  # По умолчанию True
ticks_data = loader.load_ticks_batch(
    symbol='XAUUSD',
    minute_times=df.index,
    lookback_minutes=1
)
```

При первом запуске:
1. Проверяется наличие кэша
2. Если кэша нет - загружаются последние 1.5 года
3. Тики сохраняются в `data/ticks/`

При последующих запусках:
1. Тики загружаются из кэша
2. Если нужны новые тики - догружаются только недостающие
3. Кэш автоматически обновляется

### Сохранение прогресса обработки свечей

При обработке большого количества минутных свечей прогресс автоматически сохраняется:

- **Автоматическое сохранение**: каждые 1000 свечей (настраивается)
- **Автоматическое восстановление**: при следующем запуске продолжает с места остановки
- **Файл прогресса**: `{symbol}_batch_progress.pkl` в директории кэша

Если процесс прервется:
1. При следующем запуске автоматически загрузится сохраненный прогресс
2. Обработка продолжится с незавершенных свечей
3. После успешного завершения файл прогресса автоматически удаляется

```python
# По умолчанию resume=True (продолжить с сохраненного прогресса)
ticks_data = loader.load_ticks_batch(
    symbol='XAUUSD',
    minute_times=df.index,
    lookback_minutes=1,
    save_progress_every=1000,  # Сохранять каждые 1000 свечей
    resume=True  # Продолжить с сохраненного прогресса
)

# Чтобы начать заново (игнорировать сохраненный прогресс)
ticks_data = loader.load_ticks_batch(
    symbol='XAUUSD',
    minute_times=df.index,
    resume=False  # Начать заново
)
```

### Ручное управление кэшем

```python
from data.tick_cache import TickCache

cache = TickCache()

# Проверка покрытия
coverage = cache.get_cache_coverage('XAUUSD')
if coverage:
    print(f"Кэш покрывает: {coverage[0]} - {coverage[1]}")

# Очистка кэша
cache.clear_cache('XAUUSD')  # Для конкретного символа
cache.clear_cache()  # Весь кэш

# Размер кэша
size = cache.get_cache_size('XAUUSD')
print(f"Файлов в кэше: {size}")
```

## Логика работы

### Первая загрузка

1. Проверяется наличие кэша для символа
2. Если кэша нет:
   - Вычисляется требуемый диапазон (1.5 года назад от последней свечи)
   - Загружаются тики из MT5
   - Сохраняются в кэш по дням

### Последующие загрузки

1. Проверяется покрытие кэша
2. Если кэш покрывает требуемый диапазон:
   - Тики загружаются из кэша (быстро)
3. Если нужны новые тики:
   - Догружаются только недостающие периоды
   - Кэш обновляется

### Догрузка

При необходимости большей глубины или новых данных:
- Автоматически определяется недостающий диапазон
- Загружаются только недостающие тики
- Кэш дополняется новыми данными

## Преимущества

1. **Скорость**: загрузка из кэша намного быстрее
2. **Экономия ресурсов**: не нужно каждый раз загружать из MT5
3. **Надежность**: данные сохраняются локально
4. **Автоматизация**: все работает автоматически

## Настройки

### Изменение глубины кэша

```python
loader = TickDataLoader()
loader.default_lookback_days = 365  # 1 год вместо 1.5
```

### Отключение кэша

```python
loader = TickDataLoader(use_cache=False)
```

### Изменение директории кэша

```python
loader = TickDataLoader(cache_dir='custom/ticks')
```

## Управление кэшем

### Просмотр метаданных

```python
from data.tick_cache import TickCache
import pickle

cache = TickCache()
with open('data/ticks/tick_metadata.pkl', 'rb') as f:
    metadata = pickle.load(f)
    print(metadata)
```

### Очистка старых данных

```python
cache = TickCache()
# Удалить тики старше определенной даты
# (можно реализовать дополнительный метод)
```

## Производительность

- **Загрузка из кэша**: ~0.1-1 секунда на 1000 свечей
- **Загрузка из MT5**: ~10-30 секунд на 1000 свечей
- **Первая загрузка 1.5 года**: ~5-15 минут (зависит от объема)

## Рекомендации

1. **Первая загрузка**: запустите на ночь или в нерабочее время
2. **Регулярное обновление**: кэш автоматически обновляется при необходимости
3. **Резервное копирование**: периодически копируйте `data/ticks/`
4. **Очистка**: при необходимости очищайте старые данные

## Устранение проблем

### Кэш не обновляется

Проверьте права доступа к директории `data/ticks/`

### Ошибки при загрузке

Проверьте подключение к MT5 и доступность символа

### Недостаточно места

Очистите старые данные или увеличьте место на диске

