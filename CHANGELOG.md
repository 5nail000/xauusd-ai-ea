# История изменений

Все значимые изменения в проекте документируются в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
и проект придерживается [Semantic Versioning](https://semver.org/lang/ru/).

## [2025-11-30]

### Добавлено
- **Опциональное сохранение детальных результатов анализа фичей**
  - Добавлен параметр `--save-details` в `analyze_and_exclude_features.py`
  - Добавлен параметр `--save-detailed-analyze` в `full_pipeline.py` (передает `--save-details` в скрипт анализа)
  - При использовании сохраняются детальные CSV файлы и HTML отчет в `workspace/analysis-of-features/`
  - Сохраняемые файлы:
    - `highly_correlated_pairs_threshold_*.csv` - список коррелированных пар
    - `feature_statistics.csv` - базовая статистика по фичам
    - `feature_importance.csv` - важность фичей (Mutual Info, F-score, combined_score)
    - `outliers_analysis.csv` - анализ выбросов (IQR, Z-score)
    - `feature_by_class_statistics.csv` - статистика распределения фичей по классам
    - `feature_analysis_report.html` - сводный HTML отчет
  - Основной файл `workspace/excluded_features.txt` сохраняется всегда (независимо от флага)
  - Параметр `--save-detailed-analyze` добавлен в `full_pipeline.py` для передачи `--save-details` в скрипт анализа
  - Обновлена документация с описанием детальных результатов

### Изменено
- **Объединение функционала анализа фичей в единый скрипт**
  - Удалены дублирующие скрипты `analyze_feature_correlation.py` и `analyze_features_comprehensive.py`
  - Весь функционал перенесен в `analyze_and_exclude_features.py`
  - Функции из старых скриптов встроены напрямую (без зависимостей от удаленных файлов)
  - Обновлен `full_pipeline.py` для использования нового объединенного скрипта
  - Обновлена вся документация с актуальными примерами использования

## [2025-11-29]

### Добавлено

- **Параметры командной строки для регуляризации в скриптах обучения**
  - Добавлены параметры `--dropout`, `--learning-rate` и `--weight-decay` в `train_all_models.py`
  - Добавлены параметры `--dropout`, `--learning-rate`, `--weight-decay`, `--model-type`, `--batch-size`, `--epochs`, `--patience`, `--sequence-length`, `--training-months` в `train_model.py`
  - Позволяет настраивать параметры регуляризации без изменения кода
  - Рекомендуемые значения для борьбы с переобучением: `--dropout 0.2`, `--learning-rate 5e-5`, `--weight-decay 1e-4`
  - Обновлена документация с примерами использования новых параметров

- **Параметр для отключения Temporal Encoding в Time Series Transformer**
  - Добавлен параметр `--no-temporal-encoding` в `train_all_models.py` и `train_model.py`
  - Позволяет отключить временное кодирование, если временные фичи уже включены в данные
  - **Важно**: В проекте временные фичи (hour, day_of_week, торговые сессии) уже добавляются как обычные фичи через `add_time_features()`
  - Temporal Encoding добавляет только позиционное кодирование (sinusoidal), что может быть избыточным
  - Рекомендуется использовать `--no-temporal-encoding` для уменьшения переобучения и упрощения модели
  - Обновлена документация `docs/07_MODEL_ARCHITECTURE.md` с подробным объяснением, когда отключать Temporal Encoding

- **Исправлена ошибка с количеством классов в evaluator**
  - `ModelEvaluator` теперь автоматически определяет количество классов из данных
  - Поддержка всех 5 классов: Uncertainty, Breakout Up, Breakout Down, Bounce Up, Bounce Down
  - Исправлена ошибка `Number of classes, 5, does not match size of target_names, 3`
  - Методы `print_classification_report`, `plot_confusion_matrix`, `get_class_distribution`, `evaluate_all_splits` обновлены

- **Улучшена быстрая проверка обучения**
  - `utils/quick_test_training.py` теперь корректно ограничивает данные до указанного количества месяцев
  - Веса классов вычисляются от полной выборки для сопоставимости с полным обучением
  - Добавлена фильтрация данных по дате перед обучением
  - Улучшены информационные сообщения о процессе фильтрации

- **Адаптивные умолчания для Walk-Forward Validation**
  - Параметры Walk-Forward Validation теперь вычисляются автоматически на основе доступного периода данных
  - Функция `calculate_walk_forward_params()` анализирует период данных и вычисляет оптимальные значения для train/val/test/step окон
  - Поддерживает любой период данных (не только 3/6/12 месяцев)
  - Цель: получить минимум 3-5 fold'ов для надежной валидации
  - Пользователь может переопределить параметры через CLI аргументы
  - Автоматически адаптируется под объем данных: для малых периодов уменьшает окна, для больших - увеличивает

### Добавлено

- **Walk-Forward Validation интегрирован в основной пайплайн**
  - Добавлен этап Walk-Forward Validation в `full_pipeline.py` (по умолчанию включен)
  - Параметры: `--skip-walk-forward`, `--walk-forward-train-days`, `--walk-forward-val-days`, `--walk-forward-test-days`, `--walk-forward-step-days`
  - Результаты сохраняются в `workspace/results/walk_forward/walk_forward_results.csv`
  - Walk-Forward Validation выполняется после обучения, перед бэктестингом

- **Веса классов включены по умолчанию**
  - `use_class_weights=True` по умолчанию во всех скриптах обучения
  - Добавлен флаг `--no-class-weights` для отключения весов классов
  - Метод по умолчанию: `balanced` (sklearn style)

- **Расширенное логирование параметров обучения**
  - Все параметры обучения сохраняются в `training_config.json` в директории TensorBoard логов
  - Параметры логируются в TensorBoard (текстовый формат)
  - Параметры логируются в W&B config
  - Параметры сохраняются в checkpoint файлы моделей
  - Логируемые параметры: learning_rate, weight_decay, scheduler_type, use_class_weights, class_weight_method, class_weights, dropout, d_model, n_layers, n_heads, sequence_length, num_classes, num_features, device, num_parameters

- **Реорганизация примеров**
  - `example_usage.py` перемещен в `examples/example_usage.py`
  - `test_pipeline.py` перемещен в `examples/test_pipeline.py`
  - Обновлены ссылки в документации

### Исправлено
- **Исправлено двойное копирование при скачивании тиков с Hugging Face**
  - Метод `download_ticks` в `HuggingFaceDownloader` теперь перемещает файлы вместо копирования
  - Поддиректория `ticks` автоматически удаляется после перемещения данных
  - Устранена проблема, когда данные копировались и в целевую директорию, и оставались в поддиректории
- **Улучшена загрузка тиков из кэша в offline режиме**
  - Добавлен прогресс-бар при загрузке тиков из кэша (показывается каждые 10 дней)
  - Улучшена обработка ошибок: файлы с несовместимостью numpy тихо пропускаются
  - Добавлена статистика загруженных файлов и ошибок
  - Улучшена обработка исключений при фильтрации тиков по времени
  - Система больше не зависает при загрузке большого количества файлов тиков

### Добавлено
- **Walk-Forward Validation для временных рядов**
  - Новый модуль `validation/walk_forward.py` с классом `WalkForwardValidator`
  - Реалистичная валидация модели с движущимся окном (симулирует реальную торговлю)
  - Разбиение данных на несколько окон: train -> val -> test
  - Агрегация результатов по всем окнам (mean, std, min, max, median)
  - Поддержка работы с днями или образцами
  - Пример использования: `examples/walk_forward_example.py`
  - Преимущества: обнаружение переобучения, проверка стабильности модели, адаптация к изменениям рынка
- **Class Weights для борьбы с несбалансированностью классов**
  - Функция `compute_class_weights()` в `models/data_loader.py`
  - Три метода вычисления весов: 'balanced' (sklearn style), 'inverse', 'sqrt'
  - Интеграция в `ModelTrainer` через параметры `use_class_weights` и `class_weights`
  - Автоматическое вычисление весов на основе распределения классов в обучающей выборке
  - CLI параметры: `--use-class-weights` и `--class-weight-method` в `train_all_models.py`, `train_model.py`, `full_pipeline.py`
  - Визуализация распределения классов и вычисленных весов
  - Решает проблему, когда модель учится предсказывать только доминирующий класс (Uncertainty)
- **Уровни поддержки/сопротивления и Fibonacci Retracements**
  - Новый модуль `features/level_features.py` с реализацией уровней
  - **Support/Resistance Levels**: автоматическое определение уровней через кластеризацию локальных экстремумов
    - Находит локальные минимумы/максимумы за окно lookback
    - Группирует близкие экстремумы в кластеры (зоны) на основе ATR
    - Использует центр (медиану) и ширину (std) зоны вместо пиковых значений
    - Вычисляет относительные расстояния в единицах ATR и сигмах
    - Бинарные признаки: `in_support_zone`, `in_resistance_zone`
    - Признаки близости: `proximity_to_support`, `proximity_to_resistance`
    - Сила уровня: количество касаний (`support_strength`, `resistance_strength`)
  - **Fibonacci Retracements**: вычисление уровней от swing high/low
    - Находит swing high и swing low за окно
    - Вычисляет стандартные уровни Fib: 0%, 23.6%, 38.2%, 50%, 61.8%, 78.6%, 100%
    - Расстояния до уровней в единицах ATR и процентах
    - Бинарные признаки близости к каждому уровню
    - Определение текущего уровня Fib, на котором находится цена
  - **Pivot Points** (опционально): Classic, Fibonacci, Camarilla
  - Параметры конфигурации в `FeatureConfig`:
    - `sr_lookback_window` (100), `sr_extrema_window` (5), `sr_min_touches` (3)
    - `fib_swing_window` (50), `fib_levels` (стандартные)
    - `use_pivot_points` (False), `pivot_type` ('classic')
  - Интеграция в `FeatureEngineer.create_features()` после волатильности
  - Все фичи используют относительные значения (ATR, сигмы) для лучшей работы с ML моделями
  - Примеры использования: автоматически включаются при подготовке данных
- **Комплексный анализ фичей после удаления корреляций**
  - Новый скрипт `analyze_features_comprehensive.py` для детального анализа фичей
  - Базовая статистика по фичам (mean, std, min, max, skewness, kurtosis, нормальность)
  - Анализ важности фичей (Mutual Information, F-score, корреляция с таргетом)
  - Анализ выбросов (IQR и Z-score методы)
  - Анализ распределений по классам (дифференциация между классами)
  - HTML отчет со сводной информацией и рекомендациями
  - Опциональная генерация графиков распределений и по классам
  - Интеграция в `full_pipeline.py` через параметры `--analyze-features` и `--generate-feature-plots`
  - Анализ работает независимо от удаления корреляций
  - Результаты сохраняются в `workspace/analysis-of-features/`
  - Детальное описание всех метрик и их интерпретации включено в `docs/11_FEATURE_OPTIMIZATION.md`
  - Примеры: `python full_pipeline.py --months 3 --analyze-features --generate-feature-plots`
- **Переход на формат Parquet для сохранения тиков**
  - Тики теперь сохраняются в формате Parquet (`.parquet`) вместо Pickle (`.pkl`)
  - Кроссплатформенная совместимость между Windows и Linux
  - Не зависит от версий numpy
  - Автоматическая конвертация старых pickle файлов в parquet при загрузке
  - Обратная совместимость: система поддерживает оба формата
  - Добавлена зависимость `pyarrow>=10.0.0` для работы с Parquet
  - Исправлена проблема несовместимости версий numpy при переносе тиков между платформами
- **Поддержка Hugging Face Hub в `cloud_services.py`** (переименован из `paperspace_utils.py`)
  - Классы `HuggingFaceUploader` и `HuggingFaceDownloader` для работы с Hugging Face
  - Команда `hf-upload-ticks` - загрузка тиковых данных на Hugging Face
  - Команда `hf-download-ticks` - скачивание тиковых данных с Hugging Face
  - Команда `hf-upload-features` - загрузка результатов анализа фичей (--analyze-features) на Hugging Face
  - Команда `hf-download-features` - скачивание результатов анализа фичей с Hugging Face
  - Команда `hf-upload-training` - загрузка данных для обучения (без тиков) на Hugging Face
  - Команда `hf-download-training` - скачивание данных для обучения с Hugging Face
  - Поддержка токена через `--token` или переменную окружения `HF_TOKEN`
  - Автоматическая обработка структуры директорий
  - Добавлена зависимость `huggingface_hub>=0.20.0` в requirements
  - Примеры: `python cloud_services.py hf-upload-ticks --repo-id username/dataset-name`
- **Режим offline для работы без подключения к MT5**
  - Параметр `--offline` в `prepare_gold_data.py` и `full_pipeline.py`
  - Работа только с кэшированными данными из `workspace/raw_data/ticks/`
  - Автоматическое создание минутных свечей из кэшированных тиков
  - Автоматическая агрегация старших таймфреймов из минутных данных
  - Поддержка запуска на Linux машинах без MT5
  - Функция `MT5DataLoader.aggregate_timeframe_from_minutes()` для создания старших таймфреймов
  - Примеры: `python prepare_gold_data.py --offline --days 30`, `python full_pipeline.py --offline --days 30`
- Автоматическое удаление высококоррелированных фичей в `full_pipeline.py`
  - Параметр `--remove-correlated` для включения автоматического удаления коррелированных фичей
  - Параметр `--correlation-threshold` для настройки порога корреляции (по умолчанию 0.95)
  - **Анализ на объединенном датасете** (train+val+test) для гарантии одинакового набора фичей
  - Автоматическое применение удаления ко всем трем файлам с одинаковым списком фичей
  - Создание резервных копий оригинальных файлов перед заменой (`*_backup.csv`)
  - Сохранение таблиц анализа корреляции в `workspace/prepared/features/`
  - Автоматическое создание документации по фичам после удаления коррелированных
- Поддержка указания периода данных в днях (`--days`) в дополнение к месяцам (`--months`)
  - Параметр `--days` имеет приоритет над `--months`
  - Работает в `prepare_gold_data.py` и `full_pipeline.py`
  - Примеры: `python prepare_gold_data.py --days 30`, `python full_pipeline.py --days 7`
- Реорганизация структуры проекта в `workspace/`
  - Централизованное хранение всех данных, моделей и результатов
  - Структура: `workspace/raw_data/`, `workspace/prepared/`, `workspace/models/`, `workspace/results/`
  - Упрощенная миграция данных между машинами (например, для обучения на Paperspace)
- Переход на 5 классов для классификации сигналов
  - 0 = Неопределенность
  - 1 = Пробой вверх (BUY)
  - 2 = Пробой вниз (SELL)
  - 3 = Отскок вверх (BUY после падения)
  - 4 = Отскок вниз (SELL после роста)
  - Увеличены пороги: `breakout_threshold=200.0`, `bounce_threshold=150.0`
  - Улучшена логика генерации таргетов (приоритет отскокам, проверка разворота до 70% периода)
- Отложенный вход для отскоков в бэктестере
  - Сигналы отскоков (классы 3, 4) сохраняются и ожидают подтверждения
  - Подтверждение по паттерну свечей (минимум/максимум за последние 3-5 свечей, затем разворот)
  - Настраиваемые параметры в `TradingConfig`: `bounce_confirmation_enabled`, `bounce_confirmation_periods`, `bounce_min_reversal_pips`
- Расширенный `cloud_services.py` (переименован из `paperspace_utils.py`, ранее `upload_to_paperspace.py`)
  - Классы `PaperspaceUploader` и `PaperspaceDownloader`
  - Загрузка данных для обучения с опциональными тиками и кэшами
  - Скачивание результатов обучения (модели, метрики, scalers, логи)
  - CLI интерфейс с командами: `upload-training`, `download-results`, `create-training-archive`, `create-results-archive`, `list-remote-files`
- Интеграция интерактивных метрик обучения
  - TensorBoard: автоматическое логирование метрик по батчам и эпохам
  - Weights & Biases (W&B): опциональное облачное логирование с поддержкой сравнения экспериментов
  - Скрипт `utils/start_tensorboard.py` для автоматического запуска TensorBoard
  - Документация по метрикам: `docs/14_METRICS_GUIDE.md`
- Памятка о следующих шагах: `.cursor/plans/NEXT_STEPS.md`
  - Чеклист проверок перед финальным обучением
  - Рекомендации по настройке порогов и валидации данных
  - Команды для тестирования на малой выборке

### Изменено
- Расширен `full_pipeline.py` для автоматизации оптимизации фичей
  - Добавлен опциональный этап удаления высококоррелированных фичей после подготовки данных
  - **Исправлена логика**: теперь анализ выполняется на объединенном датасете (train+val+test)
  - **Гарантируется консистентность**: одинаковый набор фичей во всех трех файлах
  - Интеграция с `analyze_feature_correlation.py` для автоматической обработки
  - Добавлена функция `analyze_combined_datasets()` для анализа на объединенном датасете
  - Автоматическое создание документации по фичам после удаления коррелированных
  - Обновлена документация с описанием новой логики
- Оптимизирована логика кэширования тиковых данных
  - Система теперь **сначала проверяет кэш** для каждой минутной свечи перед загрузкой из MT5
  - Загружает из MT5 **только недостающие** тики (вместо предварительной загрузки всего диапазона)
  - Добавлен параметр `ensure_full_coverage=False` в `load_ticks_batch()` для опциональной предзагрузки всего диапазона
  - Улучшена статистика использования кэша: показывает процент данных из кэша vs из MT5
  - Добавлена предварительная проверка кэша в начале загрузки для информирования пользователя
  - **Результат**: Значительно ускорена работа при повторной подготовке данных, если тики уже в кэше
- Улучшен скрипт анализа корреляции фичей (`analyze_feature_correlation.py`)
  - Исправлен DeprecationWarning при проверке типов данных (использование `pd.api.types.is_numeric_dtype()`)
  - Обновлены пути по умолчанию на новую структуру `workspace/`
  - Добавлено автоматическое сохранение результатов анализа в таблицы CSV:
    - Таблица высококоррелированных пар
    - Таблица фичей для удаления
    - Таблица статистики анализа
  - Добавлена защита базовых OHLC фичей (open, high, low, close) - они никогда не удаляются
  - Улучшена логика выбора фичей для удаления:
    - Приоритет отдается простым/коротким именам (sma_5 > close_rolling_mean_5)
    - Предпочтение стандартным названиям индикаторов (momentum > close_momentum_10)
    - Специальная обработка дубликатов с корреляцией = 1.0
    - Система приоритетов для разных типов фичей
- Система мониторинга производительности и защиты от деградации модели
  - PerformanceMonitor: отслеживание метрик (Win Rate, Profit Factor, просадка, серии убытков)
  - ModelDriftDetector: обнаружение дрифта модели (изменение распределения данных)
  - MonitoringVisualizer: визуализация метрик и дашборды
  - Автоматическое снижение размера позиций при предупреждениях
  - Автоматическая остановка торговли при критических ситуациях
  - Настраиваемые пороги для WARNING/CRITICAL/STOPPED протоколов
- Документация по мониторингу производительности (docs/12_PERFORMANCE_MONITORING.md)
- Прогресс-бар для обработки тиковых фичей с отображением процента выполнения, оценки оставшегося времени и скорости обработки
- Скрипт `upload_to_paperspace.py` для упаковки и отправки данных на Paperspace
- Файл `requirements_linux.txt` с зависимостями для Linux (без MetaTrader5)
- Документация по настройке обучения на Paperspace (docs/13_PAPERSPACE_SETUP.md)

### Изменено
- `data/tick_data_loader.py`: сохранение прогресса теперь ведётся чанками, чтобы чекпойнты занимали постоянное время даже на сотнях тысяч свечей
- При возобновлении загрузки прогресс собирается из отдельных чанков, а после успешного завершения промежуточные файлы автоматически очищаются

### Исправлено
- Устранены предупреждения `RuntimeWarning: invalid value encountered in divide` при вычислении корреляции и автокорреляции в статистических фичах
  - Добавлена проверка стандартного отклонения перед вычислением корреляции
  - Добавлено подавление предупреждений numpy при корректных вычислениях
  - Улучшена обработка фичей с нулевым стандартным отклонением в `_remove_correlated_features`
- Оптимизировано использование памяти при создании последовательностей для обучения
  - Изменен тип данных с `float64` на `float32` в `SequenceGenerator.create_sequences()`
  - Уменьшение использования памяти в 2 раза (с ~30 ГБ до ~15 ГБ для больших датасетов)
  - Позволяет обучать модели на машинах с 30+ ГБ RAM (например, Paperspace)

## [2025-11-25] - Исправления и оптимизации

### Исправлено
- Исправлена ошибка памяти при сохранении больших объемов тиков (50+ миллионов)
  - Убрано полное копирование DataFrame в tick_cache.py
  - Оптимизирован процесс сохранения: данные обрабатываются по частям
- Исправлено подключение к MT5
  - TickDataLoader теперь использует существующее подключение MT5
  - Предотвращены конфликты при преждевременном отключении

### Добавлено
- Автоматическое создание минутных свечей из тиков
  - Когда минутных данных недостаточно (брокер хранит только 3-6 месяцев)
  - Система автоматически дополняет недостающие периоды из тиков
- Улучшенная диагностика ошибок при загрузке данных
  - Детальные сообщения об ошибках
  - Автоматический поиск похожих символов

### Изменено
- Обновлена документация: README.md, docs/00_INDEX.md, docs/03_DATA_PREPARATION.md, docs/09_TICK_CACHE_GUIDE.md

## [2025-11-24] - Основные функции

### Добавлено
- Единый pipeline скрипт (`full_pipeline.py`)
  - Полный цикл: подготовка → обучение → бэктестинг одной командой
  - Умные проверки наличия данных/моделей
  - Гибкие параметры через командную строку
- Синхронизация фичей
  - Автоматическое сохранение метаданных о фичах в scaler
  - Валидация соответствия фичей при загрузке модели
  - Утилиты для проверки и сравнения фичей (`utils/feature_validator.py`, `validate_features.py`)
- Экспорт документации по фичам
  - Автоматическое создание документации после обучения
  - Два формата: JSON и Markdown
  - Полная информация о каждом фиче (описание, формула, источник, статистика)
  - Скрипты: `export_features_doc.py`, `utils/feature_documentation.py`
- Мониторинг аномалий
  - Отслеживание входных значений, выходящих за 3σ от обучающей выборки
  - Автоматическое снижение уверенности или пропуск сигналов при аномалиях
- Анализ корреляции фичей
  - Автоматическое удаление высококоррелированных фичей
  - Скрипт `analyze_feature_correlation.py`
  - Настраиваемый порог корреляции в `config/feature_config.py`

### Изменено
- `models/data_loader.py`: добавлено сохранение метаданных в scaler
- `trading/backtester.py`: добавлена валидация фичей и мониторинг аномалий
- `features/feature_engineering.py`: добавлено удаление коррелированных фичей
- `train_all_models.py` и `train_model.py`: автоматический экспорт документации

## [2025-11-23] - Базовые функции

### Добавлено
- Система подготовки данных
  - Загрузка данных из MT5 (минутные и тиковые)
  - Генерация фичей (технические индикаторы, тиковые фичи, временные фичи)
  - Кэширование тиковых данных
  - Создание целевых переменных (пробой, отскок, неопределенность)
- Модели Transformer
  - Encoder-Only Transformer
  - Time Series Transformer
  - Обучение с early stopping и callbacks
- Система бэктестинга
  - Управление позициями
  - Трейлинг стоп
  - Частичное закрытие
  - Расчет метрик производительности
- Документация
  - Полная документация в папке `docs/`
  - Руководства по установке, подготовке данных, обучению, бэктестингу

---

## Формат записей

- **Добавлено** - для новых функций
- **Изменено** - для изменений в существующей функциональности
- **Устарело** - для функций, которые скоро будут удалены
- **Удалено** - для удаленных функций
- **Исправлено** - для исправления ошибок
- **Безопасность** - для уязвимостей

