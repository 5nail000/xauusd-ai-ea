# История изменений

Все значимые изменения в проекте документируются в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
и проект придерживается [Semantic Versioning](https://semver.org/lang/ru/).

## [Unreleased]

### Добавлено
- Система мониторинга производительности и защиты от деградации модели
  - PerformanceMonitor: отслеживание метрик (Win Rate, Profit Factor, просадка, серии убытков)
  - ModelDriftDetector: обнаружение дрифта модели (изменение распределения данных)
  - MonitoringVisualizer: визуализация метрик и дашборды
  - Автоматическое снижение размера позиций при предупреждениях
  - Автоматическая остановка торговли при критических ситуациях
  - Настраиваемые пороги для WARNING/CRITICAL/STOPPED протоколов
- Документация по мониторингу производительности (docs/12_PERFORMANCE_MONITORING.md)
- Прогресс-бар для обработки тиковых фичей с отображением процента выполнения, оценки оставшегося времени и скорости обработки
- Скрипт `upload_to_paperspace.py` для упаковки и отправки данных на Paperspace
  - Автоматическая упаковка всех необходимых данных (CSV, тики, подготовленные данные)
  - Поддержка загрузки через SCP/RSYNC
  - Интерактивный выбор включения больших файлов (тики)
- Файл `requirements_linux.txt` для установки зависимостей на Linux без MetaTrader5
- Документация по настройке обучения на Paperspace (docs/13_PAPERSPACE_SETUP.md)

### Изменено
- `data/tick_data_loader.py`: сохранение прогресса теперь ведётся чанками, чтобы чекпойнты занимали постоянное время даже на сотнях тысяч свечей
- При возобновлении загрузки прогресс собирается из отдельных чанков, а после успешного завершения промежуточные файлы автоматически очищаются
- `models/data_loader.py`: использование `float32` вместо `float64` для последовательностей
  - Уменьшает использование памяти в 2 раза (с ~30 ГБ до ~15 ГБ для больших датасетов)
  - Критично для обучения на больших датасетах (155k+ образцов с 430 фичами)
  - Позволяет обучать модели на машинах с 30 ГБ RAM

### Исправлено
- Устранены предупреждения `RuntimeWarning: invalid value encountered in divide` при вычислении корреляции и автокорреляции в статистических фичах
  - Добавлена проверка стандартного отклонения перед вычислением корреляции
  - Добавлено подавление предупреждений numpy при корректных вычислениях
  - Улучшена обработка фичей с нулевым стандартным отклонением в `_remove_correlated_features`
- Исправлена ошибка `Unable to allocate 29.9 GiB` при создании последовательностей для обучения
  - Изменен тип данных с float64 на float32 для экономии памяти
  - Теперь возможно обучение на машинах с 30 ГБ RAM

## [2025-11-25] - Исправления и оптимизации

### Исправлено
- Исправлена ошибка памяти при сохранении больших объемов тиков (50+ миллионов)
  - Убрано полное копирование DataFrame в tick_cache.py
  - Оптимизирован процесс сохранения: данные обрабатываются по частям
- Исправлено подключение к MT5
  - TickDataLoader теперь использует существующее подключение MT5
  - Предотвращены конфликты при преждевременном отключении

### Добавлено
- Автоматическое создание минутных свечей из тиков
  - Когда минутных данных недостаточно (брокер хранит только 3-6 месяцев)
  - Система автоматически дополняет недостающие периоды из тиков
- Улучшенная диагностика ошибок при загрузке данных
  - Детальные сообщения об ошибках
  - Автоматический поиск похожих символов

### Изменено
- Обновлена документация: README.md, docs/00_INDEX.md, docs/03_DATA_PREPARATION.md, docs/09_TICK_CACHE_GUIDE.md

## [2025-11-24] - Основные функции

### Добавлено
- Единый pipeline скрипт (`full_pipeline.py`)
  - Полный цикл: подготовка → обучение → бэктестинг одной командой
  - Умные проверки наличия данных/моделей
  - Гибкие параметры через командную строку
- Синхронизация фичей
  - Автоматическое сохранение метаданных о фичах в scaler
  - Валидация соответствия фичей при загрузке модели
  - Утилиты для проверки и сравнения фичей (`utils/feature_validator.py`, `validate_features.py`)
- Экспорт документации по фичам
  - Автоматическое создание документации после обучения
  - Два формата: JSON и Markdown
  - Полная информация о каждом фиче (описание, формула, источник, статистика)
  - Скрипты: `export_features_doc.py`, `utils/feature_documentation.py`
- Мониторинг аномалий
  - Отслеживание входных значений, выходящих за 3σ от обучающей выборки
  - Автоматическое снижение уверенности или пропуск сигналов при аномалиях
- Анализ корреляции фичей
  - Автоматическое удаление высококоррелированных фичей
  - Скрипт `analyze_feature_correlation.py`
  - Настраиваемый порог корреляции в `config/feature_config.py`

### Изменено
- `models/data_loader.py`: добавлено сохранение метаданных в scaler
- `trading/backtester.py`: добавлена валидация фичей и мониторинг аномалий
- `features/feature_engineering.py`: добавлено удаление коррелированных фичей
- `train_all_models.py` и `train_model.py`: автоматический экспорт документации

## [2025-11-23] - Базовые функции

### Добавлено
- Система подготовки данных
  - Загрузка данных из MT5 (минутные и тиковые)
  - Генерация фичей (технические индикаторы, тиковые фичи, временные фичи)
  - Кэширование тиковых данных
  - Создание целевых переменных (пробой, отскок, неопределенность)
- Модели Transformer
  - Encoder-Only Transformer
  - Time Series Transformer
  - Обучение с early stopping и callbacks
- Система бэктестинга
  - Управление позициями
  - Трейлинг стоп
  - Частичное закрытие
  - Расчет метрик производительности
- Документация
  - Полная документация в папке `docs/`
  - Руководства по установке, подготовке данных, обучению, бэктестингу

---

## Формат записей

- **Добавлено** - для новых функций
- **Изменено** - для изменений в существующей функциональности
- **Устарело** - для функций, которые скоро будут удалены
- **Удалено** - для удаленных функций
- **Исправлено** - для исправления ошибок
- **Безопасность** - для уязвимостей

